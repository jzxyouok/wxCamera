<!DOCTYPE html>
<html>
<head>
    <title>丁丁停车</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="PublicCSS/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="PublicCSS/bootstrap-theme.min.css">
    <script src="PublicJs/jquery.js"></script>
    <script src="PublicJs/http.js"></script>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
</head>
<body>
<video id="myVideo" autoplay="autoplay" width="200px" height="200px"></video>
<br />
<input type="button" value="拍照" /><br />
拍照结果：
<div id="result">
</div>
<script>
var requestfront = "../ddbe/api.php?";

$(document).ready(init);
    function init() {
        //为了便于使用这个接口，先做一下兼容性处理
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        //Google Chrome用webkitGetUserMedia，Firefox用mozGetUserMedia
        navigator.getUserMedia(
            {
                video:true
            }, 
            success = function(stream) {
                $("#myVideo").attr("src", window.webkitURL.createObjectURL(stream));
                $("#myVideo").play();
            },
            error = function(error) {
                alert(error.name || error);
            }
        );  //显示影像
        //定义button点击后要做什麼
        $("input[type='button']").click(function () {
            shoot(); //执行拍照
        });
    }
    
    //拍照
    function shoot() {
        var video = $("#myVideo")[0];
        var canvas = capture(video);
        $("#result").empty();
        $("#result").append(canvas); //呈现图像(拍照结果)
        var imgData = canvas.toDataURL("image/jpg");
        var base64String = imgData.substr(22); //取得base64字串
        //上传，储存图片

        var uploadURL = requestfront + "action=uploadCamera";
        $.ajax(
            {
                url: uploadURL,
                type: "POST",
                data: { 
                    data: base64String 
                },
                async: true,
                dataType:"json",
                success: function (result) {
                    alert(result.errorcode);
                    alert(result.imgurl);
                    if (result.errorcode >= 0) {

                    };
                }, error: function (e) {
                    alert(e.responseText); //alert错误信息
                }
            }
        );
    }
    //从video元素抓取图像到canvas
    function capture(video) {
        var canvas = document.createElement('canvas'); //建立canvas js DOM元素
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0); 
        return canvas;
    } // 以后的以后
</script>

</body>
</html>

